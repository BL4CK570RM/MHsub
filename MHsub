#!/bin/bash

# Colors for output
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
NC="\e[0m" # No color

# Current version
VERSION="1.0.0"

# GitHub repository information
GITHUB_USER="BL4CK570RM"
GITHUB_REPO="MHsub"
GITHUB_BRANCH="main"
RAW_BASE_URL="https://raw.githubusercontent.com/$GITHUB_USER/$GITHUB_REPO/$GITHUB_BRANCH"

# Print MHsub ASCII Art Banner
print_banner() {
  echo -e "${GREEN}
                                                                                        bbbbbbbb            
MMMMMMMM               MMMMMMMMHHHHHHHHH     HHHHHHHHH                                  b::::::b            
M:::::::M             M:::::::MH:::::::H     H:::::::H                                  b::::::b            
M::::::::M           M::::::::MH:::::::H     H:::::::H                                  b::::::b            
M:::::::::M         M:::::::::MHH::::::H     H::::::HH                                   b:::::b            
M::::::::::M       M::::::::::M  H:::::H     H:::::H      ssssssssss   uuuuuu    uuuuuu  b:::::bbbbbbbbb    
M:::::::::::M     M:::::::::::M  H:::::H     H:::::H    ss::::::::::s  u::::u    u::::u  b::::::::::::::bb  
M:::::::M::::M   M::::M:::::::M  H::::::HHHHH::::::H  ss:::::::::::::s u::::u    u::::u  b::::::::::::::::b 
M::::::M M::::M M::::M M::::::M  H:::::::::::::::::H  s::::::ssss:::::su::::u    u::::u  b:::::bbbbb:::::::b
M::::::M  M::::M::::M  M::::::M  H:::::::::::::::::H   s:::::s  ssssss u::::u    u::::u  b:::::b    b::::::b
M::::::M   M:::::::M   M::::::M  H::::::HHHHH::::::H     s::::::s      u::::u    u::::u  b:::::b     b:::::b
M::::::M    M:::::M    M::::::M  H:::::H     H:::::H        s::::::s   u::::u    u::::u  b:::::b     b:::::b
M::::::M     MMMMM     M::::::M  H:::::H     H:::::H  ssssss   s:::::s u:::::uuuu:::::u  b:::::b     b:::::b
M::::::M               M::::::MHH::::::H     H::::::HHs:::::ssss::::::su:::::::::::::::uub:::::bbbbbb::::::b
M::::::M               M::::::MH:::::::H     H:::::::Hs::::::::::::::s  u:::::::::::::::ub::::::::::::::::b 
M::::::M               M::::::MH:::::::H     H:::::::H s:::::::::::ss    uu::::::::uu:::ub:::::::::::::::b  
MMMMMMMM               MMMMMMMMHHHHHHHHH     HHHHHHHHH  sssssssssss        uuuuuuuu  uuuubbbbbbbbbbbbbbbb    

       üîç Subdomain Enumeration Tool (v$VERSION)
     üöÄ Coded by BL4CK_570RM | 2025
${NC}"
}

# Check for updates on script run (only once per day)
check_update() {
  LATEST_VERSION=$(curl -s "$RAW_BASE_URL/version.txt")
  if [[ "$LATEST_VERSION" != "$VERSION" ]]; then
    echo -e "${YELLOW}[!] New version available: $LATEST_VERSION (Current: $VERSION)${NC}"
    return 1
  fi
  return 0
}
check_for_update() {
    local current_version="1.0.0"
    local latest_version=$(curl -s https://raw.githubusercontent.com/yourusername/MHsub/main/version.txt)

    if [[ "$latest_version" != "$current_version" ]]; then
        echo -e "\033[1;31m[!]\033[0m New version available: $latest_version (Current: $current_version)"
        echo -e "\033[1;31m[!]\033[0m Run 'MHsub --update' to get the latest version."
    else
        echo -e "\033[1;32m[*]\033[0m You are already using the latest version: $current_version"
    fi
}

LAST_UPDATE_FILE="$HOME/.mhsub_last_update_check"
if [ ! -f "$LAST_UPDATE_FILE" ] || [ "$(date +%s)" -gt $(( $(date +%s -r "$LAST_UPDATE_FILE") + 86400 )) ]; then
  if ! check_update; then
    echo -e "${YELLOW}[!] Run 'MHsub --update' to get the latest version.${NC}"
  fi
  date +%s > "$LAST_UPDATE_FILE"
fi

# Check if required tools are available
check_tools() {
  REQUIRED_TOOLS=("subfinder" "assetfinder" "sublist3r" "findomain" "httpx" "jq" "curl")
  if [ "$MODE" == "deep" ]; then
    REQUIRED_TOOLS+=("amass")
  fi

  for tool in "${REQUIRED_TOOLS[@]}"; do
    if ! command -v "$tool" &> /dev/null; then
      echo -e "${RED}[!] Required tool '$tool' is not installed.${NC}"
      exit 1
    fi
  done
}

# Check for update only and exit
if [[ "$1" == "-up" || "$1" == "--update" ]]; then
    if ! check_update; then
        read -p "Do you want to update now? [Y/n] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
            update_tool
        fi
    else
        echo -e "${GREEN}[‚úì] You already have the latest version ($VERSION).${NC}"
    fi
    exit 0
fi


# Start Subdomain Enumeration
echo -e "${BLUE}[+] Starting subdomain enumeration for: $DOMAIN${NC}"
TEMP_DIR=$(mktemp -d)
ALL_TEMP="$TEMP_DIR/all_temp.txt"
touch "$ALL_TEMP"

# Subdomain tools (lite)
echo -e "${BLUE}[+] Running Subfinder...${NC}"
subfinder -d "$DOMAIN" -silent >> "$ALL_TEMP"

echo -e "${BLUE}[+] Running Assetfinder...${NC}"
assetfinder --subs-only "$DOMAIN" >> "$ALL_TEMP"

echo -e "${BLUE}[+] Running Sublist3r...${NC}"
sublist3r -d "$DOMAIN" -o "$TEMP_DIR/sublister.txt" > /dev/null
cat "$TEMP_DIR/sublister.txt" >> "$ALL_TEMP"

echo -e "${BLUE}[+] Running Findomain...${NC}"
findomain -t "$DOMAIN" -q >> "$ALL_TEMP"

echo -e "${BLUE}[+] Running crt.sh search...${NC}"
curl -s "https://crt.sh/?q=%25.$DOMAIN&output=json" | jq -r '.[].name_value' | sed 's/\*\.//g' >> "$ALL_TEMP"

# If deep mode is selected
if [ "$MODE" == "deep" ]; then
  echo -e "${BLUE}[+] Running Amass... (this may take some time)${NC}"
  amass enum -passive -d "$DOMAIN" >> "$ALL_TEMP"
fi

# Remove duplicates and save all subdomains
sort -u "$ALL_TEMP" > "$ALL_SUBS"
echo -e "${GREEN}[+] All subdomains saved to: $ALL_SUBS${NC}"

# Check for live subdomains
echo -e "${BLUE}[+] Probing for live subdomains using httpx...${NC}"
cat "$ALL_SUBS" | httpx -silent -status-code -title -tech-detect > "$LIVE_SUBS"
echo -e "${GREEN}[+] Live subdomains saved to: $LIVE_SUBS${NC}"

# Cleanup
rm -rf "$TEMP_DIR"

echo -e "${GREEN}[‚úì] MHsub Scan Completed Successfully!${NC}"


# Update function
update_tool() {
  echo -e "${BLUE}[+] Starting update process...${NC}"
  
  # Get the script URL
  SCRIPT_URL="$RAW_BASE_URL/MHsub.sh"
  TEMP_FILE=$(mktemp)
  
  echo -e "${BLUE}[+] Downloading latest version from GitHub...${NC}"
  if ! curl -s "$SCRIPT_URL" -o "$TEMP_FILE"; then
    echo -e "${RED}[!] Failed to download update${NC}"
    echo -e "${YELLOW}[DEBUG] Tried to fetch from: $SCRIPT_URL${NC}"
    return 1
  fi
  
  # Validate the downloaded script
  if ! grep -q "MHsub üîç ‚Äî Maximum Hunt for Subdomains" "$TEMP_FILE"; then
    echo -e "${RED}[!] Downloaded file is not a valid MHsub script${NC}"
    echo -e "${YELLOW}[DEBUG] First 3 lines of downloaded file:${NC}"
    head -n 3 "$TEMP_FILE"
    rm "$TEMP_FILE"
    return 1
  fi
  
  # Create backup
  BACKUP_FILE="$0.bak"
  echo -e "${YELLOW}[+] Creating backup at $BACKUP_FILE${NC}"
  cp "$0" "$BACKUP_FILE"
  
  # Install new version
  echo -e "${BLUE}[+] Installing new version...${NC}"
  chmod +x "$TEMP_FILE"
  if ! mv "$TEMP_FILE" "$0"; then
    echo -e "${RED}[!] Failed to install update - try running with sudo${NC}"
    return 1
  fi
  
  echo -e "${GREEN}[+] Successfully updated to version $LATEST_VERSION${NC}"
  echo -e "${GREEN}[+] Restarting the script...${NC}"
  
  # Restart the script
  exec "$0" "$@"
}



# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -d|--domain)
      DOMAIN="$2"
      shift 2
      ;;
    -a|--all-subs)
      ALL_SUBS="$2"
      shift 2
      ;;
    -l|--live-subs)
      LIVE_SUBS="$2"
      shift 2
      ;;
    -m|--mode)
      MODE="$2"
      if [[ "$MODE" != "lite" && "$MODE" != "deep" ]]; then
        echo -e "${RED}[!] Invalid mode. Use 'lite' or 'deep'${NC}"
        exit 1
      fi
      shift 2
      ;;
    -up|--update)
      if check_update; then
        exit 0
      else
        read -p "Do you want to update now? [Y/n] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
          update_tool
        fi
        exit 0
      fi
      ;;
    -h|--help)
      usage
      ;;
    *)
      echo -e "${RED}[!] Unknown argument: $1${NC}"
      usage
      exit 1
      ;;
  esac
done

# ... [rest of your existing script remains exactly the same]

# Help Function
usage() {
  print_banner
  echo -e "${YELLOW}Usage:${NC}"
  echo -e "  MHsub -d <domain> -a <all_domains_output.txt> -l <live_domains_output.txt> [-m lite|deep]"
  echo -e "  MHsub --update"
  echo -e "  MHsub -h | --help"
  echo -e ""
  echo -e "${YELLOW}Required Options:${NC}"
  echo -e "  -d, --domain        Target domain to enumerate (e.g., example.com)"
  echo -e "  -a, --all-subs      Output file to save all discovered subdomains"
  echo -e "  -l, --live-subs     Output file to save live subdomains"
  echo -e ""
  echo -e "${YELLOW}Scan Modes:${NC}"
  echo -e "  -m, --mode          Scan mode (default: lite)"
  echo -e "      lite            Fast scan (skip Amass for speed)"
  echo -e "      deep            Comprehensive scan (include Amass)"
  echo -e ""
  echo -e "${YELLOW}Update Options:${NC}"
  echo -e "  -up, --update       Update MHsub to the latest version"
  echo -e ""
  echo -e "${YELLOW}Optional Flags:${NC}"
  echo -e "  -h, --help          Show this help message and exit"
  echo -e ""
  echo -e "${YELLOW}Examples:${NC}"
  echo -e "  MHsub -d example.com -a all.txt -l live.txt -m lite"
  echo -e "  MHsub --domain example.com --all-subs all.txt --live-subs live.txt --mode deep"
  echo -e "  MHsub --update"
  echo -e ""
  echo -e "${YELLOW}Description:${NC}"
  echo -e "  MHsub is a powerful subdomain enumeration tool with two scan modes:"
  echo -e "  - Lite mode (fast): Uses subfinder, assetfinder, sublister, findomain, crt.sh"
  echo -e "  - Deep mode (slow): Adds Amass for comprehensive discovery"
  exit 0
}

# Check if required tools are installed
check_tools() {
  local tools=("subfinder" "assetfinder" "sublist3r" "findomain" "jq" "httpx")
  if [[ "$MODE" == "deep" ]]; then
    tools+=("amass")
  fi
  
  local missing=()
  
  for tool in "${tools[@]}"; do
    if ! command -v "$tool" >/dev/null 2>&1; then
      missing+=("$tool")
    fi
  done

  if [ ${#missing[@]} -gt 0 ]; then
    echo -e "${RED}[!] The following tools are missing:${NC}"
    for m in "${missing[@]}"; do
      echo -e "  - $m"
    done
    echo -e "${YELLOW}Please install them before running MHsub.${NC}"
    exit 1
  fi
}

# Initialize variables
MODE="lite" # Default mode

# Validate arguments
if [ -z "$DOMAIN" ] || [ -z "$ALL_SUBS" ] || [ -z "$LIVE_SUBS" ]; then
  echo -e "${RED}[!] Error: Missing required arguments${NC}"
  usage
  exit 1
fi

print_banner

# Check for updates on script run (only once per day)
if [ ! -f ~/.mhsub_last_update_check ] || [ $(date +%s -r ~/.mhsub_last_update_check) -lt $(date +%s --date="yesterday") ]; then
  if ! check_update; then
    echo -e "${YELLOW}[!] Run 'MHsub --update' to get the latest version${NC}"
  fi
  touch ~/.mhsub_last_update_check
fi

# Check for required tools
check_tools

# Create temp directory
TMPDIR=$(mktemp -d)
echo -e "${GREEN}[+] Created temporary working directory: $TMPDIR${NC}"
echo -e "${GREEN}[+] Running in ${BLUE}$MODE${GREEN} mode${NC}"

# Function to run tools with error handling
run_tool() {
  local tool_name="$1"
  local command="$2"
  local output_file="$3"
  
  echo -e "${BLUE}[+] Running $tool_name...${NC}"
  if eval "$command" > "$output_file" 2>&1; then
    local count=$(wc -l < "$output_file" | tr -d ' ')
    echo -e "${GREEN}[+] $tool_name found $count subdomains${NC}"
  else
    echo -e "${RED}[!] $tool_name failed to run${NC}"
    touch "$output_file"
  fi
}

# Run enumeration tools in parallel
echo -e "${GREEN}[+] Starting subdomain enumeration for: $DOMAIN${NC}"

run_tool "Subfinder" "subfinder -d \"$DOMAIN\" -silent" "$TMPDIR/subfinder.txt" &
run_tool "Assetfinder" "assetfinder --subs-only \"$DOMAIN\"" "$TMPDIR/assetfinder.txt" &
run_tool "Sublist3r" "sublist3r -d \"$DOMAIN\" -o -" "$TMPDIR/sublister.txt" &
run_tool "Findomain" "findomain -t \"$DOMAIN\" -q" "$TMPDIR/findomain.txt" &
run_tool "crt.sh" "curl -s \"https://crt.sh/?q=%25.$DOMAIN&output=json\" | jq -r '.[].name_value' | sed 's/\\*\\.//g'" "$TMPDIR/crtsh.txt" &

# Only run Amass in deep mode
if [[ "$MODE" == "deep" ]]; then
  echo -e "${YELLOW}[!] Running Amass (this may take a while)...${NC}"
  run_tool "Amass" "amass enum -passive -d \"$DOMAIN\"" "$TMPDIR/amass.txt" &
fi

# Wait for all background processes to complete
wait

# Combine and deduplicate results
echo -e "${BLUE}[+] Combining and deduplicating results...${NC}"
cat "$TMPDIR"/*.txt | sort -u > "$ALL_SUBS"
TOTAL_SUBS=$(wc -l < "$ALL_SUBS" | tr -d ' ')
echo -e "${GREEN}[+] Found $TOTAL_SUBS unique subdomains. Saved to: $ALL_SUBS${NC}"

# Check for live subdomains
echo -e "${BLUE}[+] Checking for live subdomains using httpx...${NC}"
httpx -l "$ALL_SUBS" -silent -status-code -title -tech-detect -o "$TMPDIR/httpx_results.txt" 2>/dev/null

# Extract just the URLs from httpx output
awk '{print $1}' "$TMPDIR/httpx_results.txt" > "$LIVE_SUBS"
LIVE_COUNT=$(wc -l < "$LIVE_SUBS" | tr -d ' ')
echo -e "${GREEN}[+] Found $LIVE_COUNT live subdomains. Saved to: $LIVE_SUBS${NC}"

# Optional: Save full httpx results
FULL_HTTPX="${LIVE_SUBS%.*}_full_httpx.txt"
cp "$TMPDIR/httpx_results.txt" "$FULL_HTTPX"
echo -e "${GREEN}[+] Full httpx results saved to: $FULL_HTTPX${NC}"

# Cleanup
echo -e "${BLUE}[+] Cleaning up temporary files...${NC}"
rm -rf "$TMPDIR"
echo -e "${GREEN}[+] Done!${NC}"
